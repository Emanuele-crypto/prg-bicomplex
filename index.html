<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Programma Giornaliero Trasformazione Frutta - Simone Gatto</title>
<!-- Importazione librerie esterne -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css">
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<style>
 body {
     font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
     background-color: #f8f9fa;
     padding: 20px;
 }
 
 .main-header {
     background: linear-gradient(135deg, #1e3c72, #2a5298);
     color: white;
     padding: 30px;
     border-radius: 15px;
     text-align: center;
     margin-bottom: 30px;
     box-shadow: 0 8px 25px rgba(0,0,0,0.15);
 }
 
 .section-card {
     background: white;
     border-radius: 12px;
     padding: 25px;
     margin-bottom: 25px;
     box-shadow: 0 4px 15px rgba(0,0,0,0.08);
     border-left: 4px solid #2a5298;
 }
 
 .section-title {
     color: #1e3c72;
     font-weight: 600;
     margin-bottom: 20px;
     padding-bottom: 10px;
     border-bottom: 2px solid #e9ecef;
 }
 
 .form-label {
     font-weight: 600;
     color: #495057;
     margin-bottom: 8px;
 }
 
 .form-control, .form-select {
     border-radius: 8px;
     border: 2px solid #e9ecef;
     padding: 12px 15px;
     font-size: 14px;
     transition: all 0.3s ease;
 }
 
 .form-control:focus, .form-select:focus {
     border-color: #2a5298;
     box-shadow: 0 0 0 0.2rem rgba(42, 82, 152, 0.25);
 }
 
 .btn-primary {
     background: linear-gradient(135deg, #1e3c72, #2a5298);
     border: none;
     border-radius: 8px;
     padding: 12px 25px;
     font-weight: 600;
     transition: all 0.3s ease;
 }
 
 .btn-primary:hover {
     transform: translateY(-2px);
     box-shadow: 0 5px 15px rgba(42, 82, 152, 0.4);
 }
 
 .btn-success {
     background: linear-gradient(135deg, #28a745, #20c997);
     border: none;
     border-radius: 8px;
     padding: 8px 15px;
     font-weight: 600;
     transition: all 0.3s ease;
 }
 
 .btn-success:hover {
     transform: translateY(-2px);
     box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
 }
 
 .btn-warning {
     background: linear-gradient(135deg, #ffc107, #ffb300);
     border: none;
     border-radius: 8px;
     padding: 8px 15px;
     font-weight: 600;
     transition: all 0.3s ease;
     color: #212529;
 }
 
 .btn-warning:hover {
     transform: translateY(-2px);
     box-shadow: 0 5px 15px rgba(255, 193, 7, 0.4);
     color: #212529;
 }
 
 .btn-info {
     background: linear-gradient(135deg, #17a2b8, #20c997);
     border: none;
     border-radius: 8px;
     padding: 12px 25px;
     font-weight: 600;
     transition: all 0.3s ease;
     color: white;
 }
 
 .btn-info:hover {
     transform: translateY(-2px);
     box-shadow: 0 5px 15px rgba(23, 162, 184, 0.4);
     color: white;
 }
 
 .calculated-field {
     background-color: #e7f3ff;
     border-color: #bee5eb;
     font-weight: 600;
 }
 
 .supplier-row {
     background-color: #f8f9fa;
     border-radius: 10px;
     padding: 20px;
     margin-bottom: 15px;
     border: 1px solid #dee2e6;
 }
 
 .bio-indicator {
     background-color: #d4edda;
     color: #155724;
     padding: 3px 8px;
     border-radius: 12px;
     font-size: 12px;
     font-weight: 600;
 }
 
 .bio-red-text {
     color: #dc3545 !important;
     font-weight: 600;
 }
 
 .bio-black-text {
     color: #000000 !important;
     font-weight: 600;
 }
 
 .bio-red-field {
     color: #dc3545 !important;
     font-weight: 600;
     border-color: #dc3545 !important;
 }
 
 .alert-info {
     border-left: 4px solid #0dcaf0;
     background-color: #cff4fc;
     border-radius: 8px;
 }
 
 .table th {
     background-color: #1e3c72;
     color: white;
     border: none;
     font-weight: 600;
 }
 
 .table td {
     vertical-align: middle;
     border-color: #e9ecef;
 }
 
 .progress {
     height: 8px;
     border-radius: 4px;
 }
 
 .hidden-field {
     display: none;
 }
 
 .time-display {
     font-family: 'Courier New', monospace;
     font-size: 16px;
     font-weight: bold;
     color: #1e3c72;
 }
 
 .yield-result {
     background-color: #e8f5e8;
     border-color: #28a745;
     font-weight: 600;
     text-align: center;
 }
 
 .revision-info {
     font-size: 12px;
     color: #6c757d;
     margin-top: 10px;
 }
 
 .supplier-selection {
     background-color: #e8f5e8;
     border: 2px solid #28a745;
     border-radius: 8px;
     padding: 15px;
     margin-bottom: 15px;
 }
 
 .next-day {
     color: #dc3545;
     font-weight: bold;
     font-size: 12px;
 }
 
 .combination-result {
     background-color: #fff3cd;
     border: 2px solid #ffc107;
     font-weight: bold;
     color: #856404;
 }
 
 .combination-row {
     background-color: #fff3cd !important;
     border: 2px solid #ffc107 !important;
 }
 
 .combination-individual-row {
     background-color: #fff3cd !important;
     border: 1px solid #ffc107 !important;
 }
 
 .auto-sum-field {
     background-color: #fffacd !important;
     border: 2px solid #ffd700 !important;
     font-weight: bold;
 }
 
 .note-field {
     min-height: 60px;
     resize: vertical;
 }
 
 .select2-container {
     width: 100% !important;
 }
 
 .select2-container--default .select2-selection--multiple {
     border: 2px solid #e9ecef;
     border-radius: 8px;
     min-height: 45px;
     padding: 5px;
 }
 
 .select2-container--default.select2-container--focus .select2-selection--multiple {
     border-color: #2a5298;
     box-shadow: 0 0 0 0.2rem rgba(42, 82, 152, 0.25);
 }
 
 .sum-details {
     font-size: 11px;
     color: #856404;
     font-weight: normal;
     margin-top: 5px;
 }
 
 .combination-group {
     background-color: #f0f8ff;
     border: 2px solid #007bff;
     border-radius: 8px;
     padding: 15px;
     margin-bottom: 15px;
 }
 
 .combination-group-b {
     background-color: #f0fff0;
     border: 2px solid #28a745;
     border-radius: 8px;
     padding: 15px;
     margin-bottom: 15px;
 }

 /* Nuovi stili per distribuzione destinazioni */
 .distribution-section {
     background-color: #f8f9fa;
     border: 2px solid #17a2b8;
     border-radius: 8px;
     padding: 15px;
     margin-top: 15px;
 }
 
 .distribution-row {
     display: flex;
     align-items: center;
     margin-bottom: 10px;
     gap: 10px;
 }
 
 .distribution-dest {
     flex: 1;
     font-weight: 600;
     color: #17a2b8;
 }
 
 .distribution-qty {
     width: 100px;
 }

 .distribution-header {
     display: flex;
     justify-content: space-between;
     align-items: center;
     margin-bottom: 15px;
 }
 
 .remaining-qty {
     background-color: #e7f3ff;
     border: 2px solid #2a5298;
     padding: 8px;
     border-radius: 5px;
     font-weight: bold;
     text-align: center;
     color: #1e3c72;
 }
 
 .transfer-section {
     background-color: #fff3cd;
     border: 2px solid #ffc107;
     border-radius: 8px;
     padding: 10px;
     margin-top: 10px;
 }
 
 .transfer-row {
     display: flex;
     align-items: center;
     gap: 10px;
 }
 
 .total-display {
     background-color: #fff3cd;
     border: 2px solid #ffc107;
     padding: 10px;
     border-radius: 5px;
     font-weight: bold;
     text-align: center;
     margin-top: 10px;
 }

 /* Stili per evidenziare movimenti ricevuti */
 .received-transfer {
     background-color: #d4edda !important;
     border: 2px solid #28a745 !important;
 }

 .transfer-details {
     font-size: 11px;
     color: #155724;
     margin-top: 5px;
     padding: 5px;
     background-color: rgba(40, 167, 69, 0.1);
     border-radius: 3px;
 }

 /* Stili per giacenza + trasferimenti */
 .stock-plus-transfer {
     background-color: #e1f5fe !important;
     border: 2px solid #01579b !important;
     font-weight: bold;
     color: #01579b !important;
 }

 /* Stili per modal Rese */
 .yields-modal {
     position: fixed;
     top: 0;
     left: 0;
     width: 100%;
     height: 100%;
     background-color: rgba(0,0,0,0.5);
     display: none;
     z-index: 1000;
     overflow-y: auto;
 }
 
 .yields-content {
     position: relative;
     background-color: white;
     margin: 2% auto;
     padding: 20px;
     width: 90%;
     max-width: 1200px;
     min-height: 80%;
     border-radius: 15px;
 }
 
 .yields-header {
     background: linear-gradient(135deg, #1e3c72, #2a5298);
     color: white;
     padding: 20px;
     border-radius: 10px;
     margin-bottom: 20px;
     display: flex;
     justify-content: space-between;
     align-items: center;
 }
 
 .close-yields {
     color: white;
     font-size: 28px;
     font-weight: bold;
     cursor: pointer;
 }
 
 .close-yields:hover {
     color: #f0f0f0;
 }
 
 .yields-table {
     width: 100%;
     border-collapse: collapse;
     margin-top: 20px;
 }
 
 .yields-table th {
     background-color: #1e3c72;
     color: white;
     padding: 12px 8px;
     text-align: center;
     font-weight: 600;
     border: 1px solid #dee2e6;
     font-size: 12px;
 }
 
 .yields-table td {
     padding: 8px;
     text-align: center;
     border: 1px solid #dee2e6;
     vertical-align: middle;
 }
 
 .yields-table td:first-child {
     background-color: #f8f9fa;
     font-weight: 600;
     width: 120px;
 }
 
 .yields-table input[type="number"] {
     width: 70px;
     padding: 6px;
     border: 1px solid #ddd;
     border-radius: 4px;
     text-align: center;
     font-size: 12px;
 }
 
 .yields-table input[type="number"]:focus {
     border-color: #2a5298;
     outline: none;
     box-shadow: 0 0 0 0.2rem rgba(42, 82, 152, 0.25);
 }
 
 .yields-section {
     margin-bottom: 30px;
     background-color: #f8f9fa;
     padding: 20px;
     border-radius: 10px;
     border-left: 4px solid #2a5298;
 }
 
 .yields-section h5 {
     color: #1e3c72;
     margin-bottom: 15px;
     font-weight: 600;
 }
 
 .agrume-display {
     background-color: #e7f3ff;
     border: 2px solid #2a5298;
     border-radius: 8px;
     padding: 15px;
     text-align: center;
     margin-bottom: 20px;
 }
 
 .agrume-display h4 {
     color: #1e3c72;
     margin: 0;
     font-weight: bold;
 }
</style>
</head>
<body>
<div class="container-fluid">
 <!-- Header principale -->
 <div class="main-header">
     <h1><i class="bi bi-calendar-check"></i> PROGRAMMA GIORNALIERO TRASFORMAZIONE FRUTTA</h1>
     <h4>Sistema di Gestione Produzione - Simone Gatto</h4>
     <p class="mb-0">Data: <span id="current-date"></span></p>
     <div class="revision-info">
         Ultima revisione: <span id="last-revision"></span>
     </div>
 </div>

 <!-- Sezione Selezione Tipo Agrume -->
 <div class="section-card">
     <h3 class="section-title"><i class="bi bi-gear-fill"></i> Tipo di Agrume</h3>
     <div class="row">
         <div class="col-md-6">
             <label for="tipo-agrume-giornaliero" class="form-label">Seleziona Tipo di Agrume</label>
             <select class="form-select" id="tipo-agrume-giornaliero" required>
                 <option value="">Seleziona il tipo di agrume</option>
                 <option value="LIMONE">Limone</option>
                 <option value="ARANCIA">Arancia</option>
                 <option value="MANDARINO">Mandarino</option>
                 <option value="POMPELMO">Pompelmo</option>
                 <option value="BERGAMOTTO">Bergamotto</option>
             </select>
         </div>
         <div class="col-md-6">
             <label for="data-lavorazione" class="form-label">Data Lavorazione</label>
             <input type="date" class="form-control" id="data-lavorazione" required>
         </div>
     </div>
 </div>

 <!-- Sezione Totali -->
 <div class="section-card">
     <h3 class="section-title"><i class="bi bi-boxes"></i> Quantità Totali</h3>
     <div class="row">
         <div class="col-md-4">
             <label for="entrata-giornaliera" class="form-label">Entrata Giornaliera Totale (kg)</label>
             <input type="number" class="form-control calculated-field" id="entrata-giornaliera" readonly>
         </div>
         <div class="col-md-4">
             <label for="trasformata-totale" class="form-label">Quantità trasformata Totale (kg)</label>
             <input type="number" class="form-control calculated-field" id="trasformata-totale" readonly>
         </div>
         <div class="col-md-4">
             <label for="giacenza-totale" class="form-label">Giacenza Totale (kg)</label>
             <input type="number" class="form-control calculated-field" id="giacenza-totale" readonly>
         </div>
     </div>
 </div>

 <!-- Sezione Fornitori -->
 <div class="section-card">
     <h3 class="section-title"><i class="bi bi-truck"></i> Dettagli Fornitori e Lavorazione</h3>
     <div class="alert alert-info">
         <i class="bi bi-info-circle"></i> Aggiungi i fornitori e configura i parametri di lavorazione per ciascuno. L'orario di fine verrà calcolato automaticamente.
     </div>
     
     <div id="fornitori-container">
         <!-- I fornitori verranno aggiunti dinamicamente qui -->
     </div>
     
     <button type="button" class="btn btn-primary" id="aggiungi-fornitore">
         <i class="bi bi-plus-circle"></i> Aggiungi Fornitore
     </button>
 </div>

 <!-- Sezione Selezione Combinazioni Fornitori -->
 <div id="combinazioni-section" class="section-card hidden-field">
     <h3 class="section-title"><i class="bi bi-diagram-3"></i> Selezione Combinazioni Fornitori</h3>
     
     <!-- Combinazione A -->
     <div class="combination-group">
         <h5><i class="bi bi-diagram-2"></i> Combinazione A - Succo 1ª</h5>
         <div class="row">
             <div class="col-md-12">
                 <label class="form-label">Seleziona Fornitori da Combinare per Succo 1ª (fino a 3 fornitori)</label>
                 <select class="form-select" id="combinazione-fornitori-a">
                     <option value="">Seleziona combinazione A</option>
                     <!-- Opzioni generate dinamicamente -->
                 </select>
                 <div class="mt-3">
                     <button type="button" class="btn btn-success me-2" id="applica-combinazione-a">
                         <i class="bi bi-check-circle"></i> Applica Combinazione A
                     </button>
                     <button type="button" class="btn btn-warning" id="reset-combinazione-a">
                         <i class="bi bi-x-circle"></i> Reset Combinazione A
                     </button>
                     <small class="text-muted d-block mt-2">
                         Il risultato sostituirà la quantità succo 1ª nell'ultimo fornitore incluso nella combinazione A
                     </small>
                 </div>
             </div>
         </div>
     </div>
     
     <!-- Combinazione B -->
     <div class="combination-group-b">
         <h5><i class="bi bi-diagram-3"></i> Combinazione B - Succo 1ª</h5>
         <div class="row">
             <div class="col-md-12">
                 <label class="form-label">Seleziona Fornitori da Combinare per Succo 1ª (fino a 3 fornitori)</label>
                 <select class="form-select" id="combinazione-fornitori-b">
                     <option value="">Seleziona combinazione B</option>
                     <!-- Opzioni generate dinamicamente -->
                 </select>
                 <div class="mt-3">
                     <button type="button" class="btn btn-success me-2" id="applica-combinazione-b">
                         <i class="bi bi-check-circle"></i> Applica Combinazione B
                     </button>
                     <button type="button" class="btn btn-warning" id="reset-combinazione-b">
                         <i class="bi bi-x-circle"></i> Reset Combinazione B
                     </button>
                     <small class="text-muted d-block mt-2">
                         Il risultato sostituirà la quantità succo 1ª nell'ultimo fornitore incluso nella combinazione B
                     </small>
                 </div>
             </div>
         </div>
     </div>
 </div>

 <!-- Pulsanti di azione -->
 <div class="section-card text-center">
     <button type="button" class="btn btn-primary btn-lg me-3" id="rese-button">
         <i class="bi bi-bar-chart-line-fill"></i> Rese
     </button>
     <button type="button" class="btn btn-outline-secondary btn-lg me-3" id="anteprima-stampa">
         <i class="bi bi-printer"></i> Anteprima Stampa
     </button>
     <button type="button" class="btn btn-outline-danger btn-lg" id="reset-programma">
         <i class="bi bi-arrow-clockwise"></i> Reset Programma
     </button>
 </div>
</div>

<!-- Modal Rese -->
<div id="yields-modal" class="yields-modal">
 <div class="yields-content">
     <div class="yields-header">
         <h2><i class="bi bi-bar-chart-line-fill"></i> Gestione Rese per Agrume</h2>
         <span class="close-yields">&times;</span>
     </div>
     
     <div class="agrume-display">
         <h4 id="agrume-selected">Nessun agrume selezionato</h4>
     </div>
     
     <div class="yields-section">
         <h5><i class="bi bi-droplet"></i> Rese Succo 1ª (%)</h5>
         <table class="yields-table">
             <thead>
                 <tr>
                     <th>Resa</th>
                     <th>Gen</th>
                     <th>Feb</th>
                     <th>Mar</th>
                     <th>Apr</th>
                     <th>Mag</th>
                     <th>Giu</th>
                     <th>Lug</th>
                     <th>Ago</th>
                     <th>Set</th>
                     <th>Ott</th>
                     <th>Nov</th>
                     <th>Dic</th>
                 </tr>
             </thead>
             <tbody>
                 <tr>
                     <td><strong>Succo 1ª (%)</strong></td>
                     <td><input type="number" class="yield-input" data-type="prima" data-month="1" min="0" max="100" step="0.1"></td>
                     <td><input type="number" class="yield-input" data-type="prima" data-month="2" min="0" max="100" step="0.1"></td>
                     <td><input type="number" class="yield-input" data-type="prima" data-month="3" min="0" max="100" step="0.1"></td>
                     <td><input type="number" class="yield-input" data-type="prima" data-month="4" min="0" max="100" step="0.1"></td>
                     <td><input type="number" class="yield-input" data-type="prima" data-month="5" min="0" max="100" step="0.1"></td>
                     <td><input type="number" class="yield-input" data-type="prima" data-month="6" min="0" max="100" step="0.1"></td>
                     <td><input type="number" class="yield-input" data-type="prima" data-month="7" min="0" max="100" step="0.1"></td>
                     <td><input type="number" class="yield-input" data-type="prima" data-month="8" min="0" max="100" step="0.1"></td>
                     <td><input type="number" class="yield-input" data-type="prima" data-month="9" min="0" max="100" step="0.1"></td>
                     <td><input type="number" class="yield-input" data-type="prima" data-month="10" min="0" max="100" step="0.1"></td>
                     <td><input type="number" class="yield-input" data-type="prima" data-month="11" min="0" max="100" step="0.1"></td>
                     <td><input type="number" class="yield-input" data-type="prima" data-month="12" min="0" max="100" step="0.1"></td>
                 </tr>
             </tbody>
         </table>
     </div>
     
     <div class="yields-section">
         <h5><i class="bi bi-droplet"></i> Rese Succo 2ª (%)</h5>
         <table class="yields-table">
             <thead>
                 <tr>
                     <th>Resa</th>
                     <th>Gen</th>
                     <th>Feb</th>
                     <th>Mar</th>
                     <th>Apr</th>
                     <th>Mag</th>
                     <th>Giu</th>
                     <th>Lug</th>
                     <th>Ago</th>
                     <th>Set</th>
                     <th>Ott</th>
                     <th>Nov</th>
                     <th>Dic</th>
                 </tr>
             </thead>
             <tbody>
                 <tr>
                     <td><strong>Succo 2ª (%)</strong></td>
                     <td><input type="number" class="yield-input" data-type="seconda" data-month="1" min="0" max="100" step="0.1"></td>
                     <td><input type="number" class="yield-input" data-type="seconda" data-month="2" min="0" max="100" step="0.1"></td>
                     <td><input type="number" class="yield-input" data-type="seconda" data-month="3" min="0" max="100" step="0.1"></td>
                     <td><input type="number" class="yield-input" data-type="seconda" data-month="4" min="0" max="100" step="0.1"></td>
                     <td><input type="number" class="yield-input" data-type="seconda" data-month="5" min="0" max="100" step="0.1"></td>
                     <td><input type="number" class="yield-input" data-type="seconda" data-month="6" min="0" max="100" step="0.1"></td>
                     <td><input type="number" class="yield-input" data-type="seconda" data-month="7" min="0" max="100" step="0.1"></td>
                     <td><input type="number" class="yield-input" data-type="seconda" data-month="8" min="0" max="100" step="0.1"></td>
                     <td><input type="number" class="yield-input" data-type="seconda" data-month="9" min="0" max="100" step="0.1"></td>
                     <td><input type="number" class="yield-input" data-type="seconda" data-month="10" min="0" max="100" step="0.1"></td>
                     <td><input type="number" class="yield-input" data-type="seconda" data-month="11" min="0" max="100" step="0.1"></td>
                     <td><input type="number" class="yield-input" data-type="seconda" data-month="12" min="0" max="100" step="0.1"></td>
                 </tr>
             </tbody>
         </table>
     </div>
     
     <div class="yields-section">
         <h5><i class="bi bi-droplet"></i> Rese Torchiato (%)</h5>
         <table class="yields-table">
             <thead>
                 <tr>
                  <th>Resa</th>
                    <th>Gen</th>
                    <th>Feb</th>
                    <th>Mar</th>
                    <th>Apr</th>
                    <th>Mag</th>
                    <th>Giu</th>
                    <th>Lug</th>
                   <th>Ago</th>
                   <th>Set</th>
                   <th>Ott</th>
                   <th>Nov</th>
                   <th>Dic</th>
               </tr>
           </thead>
           <tbody>
               <tr>
                   <td><strong>Torchiato (%)</strong></td>
                   <td><input type="number" class="yield-input" data-type="torchiato" data-month="1" min="0" max="100" step="0.1"></td>
                   <td><input type="number" class="yield-input" data-type="torchiato" data-month="2" min="0" max="100" step="0.1"></td>
                  <td><input type="number" class="yield-input" data-type="torchiato" data-month="3" min="0" max="100" step="0.1"></td>
                  <td><input type="number" class="yield-input" data-type="torchiato" data-month="4" min="0" max="100" step="0.1"></td>
                  <td><input type="number" class="yield-input" data-type="torchiato" data-month="5" min="0" max="100" step="0.1"></td>
                  <td><input type="number" class="yield-input" data-type="torchiato" data-month="6" min="0" max="100" step="0.1"></td>
                  <td><input type="number" class="yield-input" data-type="torchiato" data-month="7" min="0" max="100" step="0.1"></td>
                  <td><input type="number" class="yield-input" data-type="torchiato" data-month="8" min="0" max="100" step="0.1"></td>
                  <td><input type="number" class="yield-input" data-type="torchiato" data-month="9" min="0" max="100" step="0.1"></td>
                  <td><input type="number" class="yield-input" data-type="torchiato" data-month="10" min="0" max="100" step="0.1"></td>
                  <td><input type="number" class="yield-input" data-type="torchiato" data-month="11" min="0" max="100" step="0.1"></td>
                  <td><input type="number" class="yield-input" data-type="torchiato" data-month="12" min="0" max="100" step="0.1"></td>
              </tr>
          </tbody>
      </table>
  </div>
  
  <div class="text-center mt-4">
      <button type="button" class="btn btn-success btn-lg me-3" id="salva-rese">
          <i class="bi bi-save"></i> Salva Rese
      </button>
      <button type="button" class="btn btn-outline-secondary btn-lg" id="reset-rese">
          <i class="bi bi-arrow-clockwise"></i> Reset Valori
      </button>
  </div>
</div>
</div>

<!-- Template per fornitore -->
<div id="fornitore-template" class="hidden-field">
<div class="supplier-row" data-supplier-index="">
 <div class="d-flex justify-content-between align-items-center mb-3">
     <h5><i class="bi bi-building"></i> Fornitore <span class="supplier-number"></span></h5>
     <button type="button" class="btn btn-outline-danger btn-sm rimuovi-fornitore">
         <i class="bi bi-trash"></i> Rimuovi
     </button>
 </div>
 
 <div class="row g-3">
     <!-- Dati base fornitore -->
     <div class="col-md-3">
         <label class="form-label">Nome Fornitore</label>
         <select class="form-select nome-fornitore" required>
             <option value="">Seleziona fornitore</option>
             <option value="RESTUCCIA">RESTUCCIA</option>
             <option value="CI">CI</option>
             <option value="ARCO">ARCO</option>
             <option value="GIOVINAZZO">GIOVINAZZO</option>
             <option value="AZ.T.C.">AZ.T.C.</option>
             <option value="M.B.T.F.">M.B.T.F.</option>                  
             <option value="VASTA">VASTA</option>
             <option value="APAL">APAL</option> 
             <option value="GEIMA">GEIMA</option>
             <option value="UNIONBERG">UNIONBERG</option>                  
             <option value="ALTRO">ALTRO</option>
         </select>
         <input type="text" class="form-control mt-2 altro-fornitore hidden-field" placeholder="Specifica altro fornitore">
     </div>
     
     <div class="col-md-3">
         <label class="form-label">Quantità in Entrata (kg)</label>
         <input type="number" class="form-control quantita-fornitore" min="0" required>
     </div>
     
     <div class="col-md-3">
         <label class="form-label">Quantità trasformata (kg)</label>
         <input type="number" class="form-control quantita-trasformata" min="0" placeholder="0">
     </div>
     
     <div class="col-md-3">
         <label class="form-label">Giacenza (kg)</label>
         <input type="number" class="form-control calculated-field giacenza-fornitore" readonly>
     </div>
     
     <div class="col-md-4">
         <label class="form-label">Certificazione Prodotto</label>
         <select class="form-select certificazione-prodotto" required>
             <option value="">Seleziona certificazione</option>
             <option value="BIO EU">BIO EU</option>
             <option value="BIO DEM">BIO DEM</option>
             <option value="BIO NTD">BIO NTD</option>
             <option value="BIO DEM/NTD">BIO DEM/NTD</option>
             <option value="TRACCIATO">TRACCIATO</option>
             <option value="IGP">IGP</option>
             <option value="CONVENZIONALE">CONVENZIONALE</option>
             <option value="ALTRO">ALTRO</option>
         </select>
         <input type="text" class="form-control mt-2 altra-certificazione hidden-field" placeholder="Specifica altra certificazione">
     </div>
     
     <div class="col-md-4">
         <label class="form-label">Varietà</label>
         <select class="form-select varieta-prodotto" required>
             <option value="">Seleziona varietà</option>
             <!-- Opzioni dinamiche in base al tipo di agrume -->
         </select>
         <input type="text" class="form-control mt-2 altra-varieta hidden-field" placeholder="Specifica altra varietà">
     </div>
     
     <!-- Parametri lavorazione -->
     <div class="col-md-4">
         <label class="form-label">Linea di Trasformazione</label>
         <select class="form-select linea-trasformazione" required>
             <option value="">Seleziona linea</option>
             <option value="BOE/1100">BOE/1100</option>
             <option value="GOE INT/POLY">GOE INT/POLY</option>
             <option value="GOE EST/POLY">GOE EST/POLY</option>
             <option value="GOE EST/400">GOE EST/400</option>
             <option value="B/SF">B/SF</option>
             <option value="TORCHI FASO">TORCHI FASO</option>
         </select>
     </div>
     
     <div class="col-md-6">
         <label class="form-label">Portata Impianto (kg/h)</label>
         <input type="number" class="form-control portata-impianto" min="100" max="5000" required>
     </div>
     
     <div class="col-md-6">
         <label class="form-label">Orario Inizio Lavorazione stimato</label>
         <input type="time" class="form-control orario-inizio" required>
     </div>
     
     <div class="col-md-6">
         <label class="form-label">Orario Fine Lavorazione stimato</label>
         <div class="orario-fine-display calculated-field form-control"></div>
     </div>
     
     <div class="col-md-6">
         <label class="form-label">Durata Lavorazione stimata</label>
         <input type="text" class="form-control calculated-field durata-lavorazione" readonly>
     </div>
 </div>
 
 <!-- Sezione Rese e Destinazioni -->
 <div class="mt-4">
     <h6><i class="bi bi-droplet"></i> Calcolo Rese e Destinazioni Spremiture</h6>
     
     <div class="row g-3 mt-2">
         <!-- Rese percentuali -->
         <div class="col-md-4">
             <label class="form-label">Resa Succo 1ª (%)</label>
             <input type="number" class="form-control resa-prima" step="0.1" min="0" max="100" placeholder="Auto">
         </div>
         
         <div class="col-md-4 seconda-section">
            <label class="form-label">Resa Succo 2ª (%)</label>
            <input type="number" class="form-control resa-seconda" step="0.1" min="0" max="100" placeholder="Auto">
        </div>
        
        <div class="col-md-4">
            <label class="form-label">Resa Torchiato (%)</label>
           <input type="number" class="form-control resa-torchiato" step="0.1" min="0" max="100" placeholder="Auto">
       </div>
   </div>
   
   <!-- Risultati calcolo rese in kg -->
   <div class="row g-3 mt-2">
       <div class="col-md-4">
           <label class="form-label">Quantità Succo 1ª (kg)</label>
           <input type="number" class="form-control yield-result quantita-prima" readonly>
           
           <!-- Dettagli trasferimenti ricevuti -->
           <div class="transfer-details hidden-field"></div>
       </div>
       
       <div class="col-md-4 seconda-section">
           <label class="form-label">Quantità Succo 2ª (kg)</label>
           <input type="number" class="form-control yield-result quantita-seconda" readonly>
           <div class="sum-details seconda-details"></div>
       </div>
       
       <div class="col-md-4">
           <label class="form-label">Quantità Torchiato (kg)</label>
           <input type="number" class="form-control yield-result quantita-torchiato" readonly>
           <div class="sum-details torchiato-details"></div>
       </div>
   </div>
   
   <!-- Destinazioni spremiture -->
   <div class="row g-3 mt-3">
       <div class="col-md-4">
           <label class="form-label destinazione-prima-label">Destinazione Succo 1ª</label>
           <select class="form-select destinazione-prima" multiple>
               <option value="NAT IN TINI">NAT IN TINI</option>
               <option value="PET 100">PET 100</option>
               <option value="PET 200">PET 200</option>
               <option value="PET 480">PET 480</option>
               <option value="ACMA">ACMA</option>
               <option value="REX">REX</option>
               <option value="GOGLIO">GOGLIO</option>
               <option value="VASCHETTE">VASCHETTE</option>
               <option value="VASCHETTE ZUCCHERATE">VASCHETTE ZUCCHERATE</option>
              <option value="LATTE">LATTE</option>
              <option value="F.F.">F.F.</option>
              <option value="F.T.C">F.T.C</option>
              <option value="FBL">FBL</option>
              <option value="BIC">BIC</option>
              <option value="CISTERNA P">CISTERNA P</option>
              <option value="CISTERNA EF">CISTERNA EF</option>
              <option value="CISTERNA VK">CISTERNA VK</option>
              <option value="CISTERNA GS">CISTERNA GS</option>
              <option value="CISTERNA CARTH.">CISTERNA CARTH.</option>
              <option value="CONCENTRATO">CONCENTRATO</option>
              <option value="ALTRO">ALTRO</option>
          </select>
          <input type="text" class="form-control mt-2 altra-destinazione hidden-field" placeholder="Specifica altra destinazione">
          
          <!-- Sezione distribuzione quantità per destinazioni -->
          <div class="distribution-section mt-3 hidden-field">
              <div class="distribution-header">
                  <h6><i class="bi bi-distribute-horizontal"></i> Distribuzione Quantità</h6>
                  <div class="remaining-qty">Rimanente: <span class="remaining-value">0</span> kg</div>
              </div>
              <div class="distribution-container">
                  <!-- Le righe di distribuzione verranno aggiunte dinamicamente -->
              </div>
              <!-- Sezione trasferimento esubero -->
              <div class="transfer-section hidden-field">
                  <div class="transfer-row">
                      <label class="form-label">Invia esubero a:</label>
                      <select class="form-select transfer-destination" style="width: 150px;">
                          <option value="">Seleziona fornitore</option>
                      </select>
                      <input type="number" class="form-control transfer-qty" placeholder="kg" min="0" step="0.1" style="width: 100px;">
                      <button type="button" class="btn btn-sm btn-success execute-transfer">
                          <i class="bi bi-arrow-right"></i> Trasferisci
                      </button>
                  </div>
              </div>
          </div>
      </div>
      
      <div class="col-md-4 seconda-section">
          <label class="form-label">Destinazione Succo 2ª</label>
          <select class="form-select destinazione-seconda">
              <option value="">Seleziona destinazione</option>
              <option value="NAT IN TINI" selected>NAT IN TINI</option>
              <option value="CONCENTRATO">CONCENTRATO</option>
              <option value="ALTRO">ALTRO</option>
          </select>
          <input type="text" class="form-control mt-2 altra-destinazione hidden-field" placeholder="Specifica altra destinazione">
      </div>
      
      <div class="col-md-4">
          <label class="form-label">Destinazione Torchiato</label>
          <select class="form-select destinazione-torchiato">
              <option value="">Seleziona destinazione</option>
              <option value="NAT IN TINI">NAT IN TINI</option>
              <option value="F.F.">F.F.</option>
              <option value="F.T.C">F.T.C</option>
              <option value="FBL">FBL</option>
              <option value="BIC">BIC</option>
              <option value="CONCENTRATO" selected>CONCENTRATO</option>
              <option value="ALTRO">ALTRO</option>
          </select>
          <input type="text" class="form-control mt-2 altra-destinazione hidden-field" placeholder="Specifica altra destinazione">
      </div>
  </div>
  
  <!-- Pastorizzazione -->
  <div class="row g-3 mt-3">
      <div class="col-md-4">
          <label class="form-label">Pastorizzato</label>
          <select class="form-select pastorizzato-prima">
              <option value="SI">SI</option>
              <option value="NO">NO</option>
          </select>
      </div>
      
      <div class="col-md-4 seconda-section">
          <label class="form-label">Pastorizzato</label>
          <select class="form-select pastorizzato-seconda">
              <option value="SI">SI</option>
              <option value="NO">NO</option>
          </select>
      </div>
      
      <div class="col-md-4">
          <label class="form-label">Pastorizzato</label>
          <select class="form-select pastorizzato-torchiato">
              <option value="SI">SI</option>
              <option value="NO">NO</option>
          </select>
      </div>
  </div>
  
  <!-- Tenore di polpa, Brix e Bio per ogni prodotto -->
  <div class="row g-3 mt-3">
      <div class="col-md-4">
          <label class="form-label">Tenore Polpa Succo 1ª</label>
          <select class="form-select tenore-polpa-prima">
              <option value="STANDARD">STANDARD</option>
              <option value="LIMPIDO">LIMPIDO</option>
              <option value="SEMICLEAR">SEMICLEAR</option>
              <option value="<1%"><1%</option>
              <option value="2%">2%</option>
              <option value="3%">3%</option>
              <option value="6%">6%</option>
              <option value="ALTRO">ALTRO</option>
          </select>
          <input type="text" class="form-control mt-2 altro-tenore-prima hidden-field" placeholder="Specifica altro tenore">
          
          <label class="form-label mt-2">Brix</label>
          <select class="form-select brix-prima">
              <option value="NAT">NAT</option>
              <option value="20">20</option>
              <option value="32">32</option>
              <option value="40">40</option>
              <option value="41">41</option>
              <option value="45">45</option>
              <option value="55">55</option>
              <option value="58">58</option>
              <option value="60">60</option>
              <option value="63.5">63.5</option>
              <option value="65">65</option>
              <option value="ALTRO">ALTRO</option>
          </select>
          <input type="text" class="form-control mt-2 altro-brix-prima hidden-field" placeholder="Specifica altro Brix">
          
          <label class="form-label mt-2">Biologico</label>
          <select class="form-select bio-prima">
              <option value="SI">SI</option>
              <option value="NO">NO</option>
              <option value="DECLASSATO">DECLASSATO</option>
          </select>
          
          <label class="form-label mt-2">Conservato</label>
          <select class="form-select conservato-prima">
              <option value="SI">SI</option>
              <option value="NO" selected>NO</option>
          </select>
          
          <label class="form-label mt-2">Note</label>
          <textarea class="form-control note-field note-prima" placeholder="Inserisci note per Succo 1ª"></textarea>
      </div>
      
      <div class="col-md-4 seconda-section">
          <label class="form-label">Tenore Polpa Succo 2ª</label>
          <select class="form-select tenore-polpa-seconda">
              <option value="STANDARD">STANDARD</option>
              <option value="LIMPIDO">LIMPIDO</option>
              <option value="SEMICLEAR">SEMICLEAR</option>
              <option value="<1%" selected><1%</option>
              <option value="2%">2%</option>
              <option value="3%">3%</option>
              <option value="6%">6%</option>
              <option value="ALTRO">ALTRO</option>
          </select>
          <input type="text" class="form-control mt-2 altro-tenore-seconda hidden-field" placeholder="Specifica altro tenore">
          
          <label class="form-label mt-2">Brix</label>
          <select class="form-select brix-seconda">
              <option value="NAT">NAT</option>
              <option value="20">20</option>
              <option value="32">32</option>
              <option value="40">40</option>
              <option value="41">41</option>
              <option value="45">45</option>
              <option value="55">55</option>
              <option value="58">58</option>
              <option value="60">60</option>
              <option value="63.5">63.5</option>
              <option value="65">65</option>
              <option value="ALTRO">ALTRO</option>
          </select>
          <input type="text" class="form-control mt-2 altro-brix-seconda hidden-field" placeholder="Specifica altro Brix">
          
          <label class="form-label mt-2">Conservato</label>
          <select class="form-select conservato-seconda">
              <option value="SI">SI</option>
              <option value="NO">NO</option>
          </select>
          
          <label class="form-label mt-2">Note</label>
          <textarea class="form-control note-field note-seconda" placeholder="Inserisci note per Succo 2ª"></textarea>
      </div>
      
      <div class="col-md-4">
          <label class="form-label">Tenore Polpa Torchiato</label>
          <select class="form-select tenore-polpa-torchiato">
              <option value="STANDARD">STANDARD</option>
              <option value="LIMPIDO">LIMPIDO</option>
              <option value="SEMICLEAR">SEMICLEAR</option>
              <option value="<1%" selected><1%</option>
              <option value="2%">2%</option>
              <option value="3%">3%</option>
              <option value="6%">6%</option>
              <option value="ALTRO">ALTRO</option>
          </select>
          <input type="text" class="form-control mt-2 altro-tenore-torchiato hidden-field" placeholder="Specifica altro tenore">
          
          <label class="form-label mt-2">Brix</label>
          <select class="form-select brix-torchiato">
              <option value="NAT">NAT</option>
              <option value="20">20</option>
              <option value="32">32</option>
              <option value="40">40</option>
              <option value="41">41</option>
              <option value="45" selected>45</option>
              <option value="55">55</option>
              <option value="58">58</option>
              <option value="60">60</option>
              <option value="63.5">63.5</option>
              <option value="65">65</option>
              <option value="ALTRO">ALTRO</option>
          </select>
          <input type="text" class="form-control mt-2 altro-brix-torchiato hidden-field" placeholder="Specifica altro Brix">
          
          <label class="form-label mt-2">Conservato</label>
          <select class="form-select conservato-torchiato">
              <option value="SI">SI</option>
              <option value="NO" selected>NO</option>
          </select>
          
          <label class="form-label mt-2">Note</label>
          <textarea class="form-control note-field note-torchiato" placeholder="Inserisci note per Torchiato"></textarea>
      </div>
  </div>
</div>
</div>
</div>

<script>
$(document).ready(function() {
let supplierCount = 0;
let programData = {};

// Variabili per le combinazioni - MODIFICATE per supportare A e B
let lastCombinationSuppliersA = '';
let combinationDetailsA = [];
let combinationSupplierIndexesA = [];

let lastCombinationSuppliersB = '';
let combinationDetailsB = [];
let combinationSupplierIndexesB = [];

let sumDetailsSeconda = {};
let sumDetailsTorchiato = {};

// Variabili per gestione rese
let yieldsData = {};

// Variabili per gestione trasferimenti - MODIFICATE per tracciare giacenza + trasferimenti
let transferData = {};
let stockPlusTransferData = {}; // Nuova variabile per tracciare giacenza + trasferimenti

// Definizione varietà per ogni tipo di agrume
const varietyOptions = {
  'LIMONE': [
      { value: 'VERDELLO', text: 'Verdello' },
      { value: 'FEMMINELLO', text: 'Femminello' },
      { value: 'INTERDONATO', text: 'Interdonato' },
      { value: 'BIANCHETTO', text: 'Bianchetto' },
      { value: 'MONACHELLO', text: 'Monachello' },
      { value: 'VARIE', text: 'Varie' },
      { value: 'ALTRO', text: 'Altro (specifica quale)' }
  ],
  'MANDARINO': [
      { value: 'TARD. DI CIACULLI', text: 'Tard. di Ciaculli' },
      { value: 'AVANA', text: 'Avana' },
      { value: 'CLEMENTINO', text: 'Clementino' },
      { value: 'VARIE', text: 'Varie' },
      { value: 'ALTRO', text: 'Altro (specifica quale)' }
  ],
  'ARANCIA': [
      { value: 'BIONDA', text: 'Bionda' },
      { value: 'MORO', text: 'Moro' },
      { value: 'SANGUINELLA', text: 'Sanguinella' },
      { value: 'TAROCCO', text: 'Tarocco' },
      { value: 'VARIE', text: 'Varie' },
      { value: 'ALTRO', text: 'Altro (specifica quale)' }
  ],
  'BERGAMOTTO': [
      { value: 'FEMMINELLO', text: 'Femminello' },
      { value: 'CASTAGNARO', text: 'Castagnaro' },
      { value: 'VARIE', text: 'Varie' },
      { value: 'ALTRO', text: 'Altro (specifica quale)' }
  ],
  'POMPELMO': [
      { value: 'GIALLO', text: 'Giallo' },
      { value: 'ROSA', text: 'Rosa' },
      { value: 'VARIE', text: 'Varie' },
      { value: 'ALTRO', text: 'Altro (specifica quale)' }
  ]
};

// Inizializzazione data corrente e ultima revisione
function initCurrentDate() {
  const today = new Date();
  const formatted = today.toLocaleDateString('it-IT', {
      weekday: 'long',
      year: 'numeric',
      month: 'long',
      day: 'numeric'
  });
  $('#current-date').text(formatted);
  $('#data-lavorazione').val(today.toISOString().split('T')[0]);
  
  updateLastRevision();
}

// Aggiorna ultima revisione
function updateLastRevision() {
  const now = new Date();
  const lastRevision = now.toLocaleDateString('it-IT') + ' - ' + now.toLocaleTimeString('it-IT');
  $('#last-revision').text(lastRevision);
}

// Aggiorna opzioni varietà in base al tipo di agrume selezionato
function updateVarietyOptions(supplierElement, tipoAgrume) {
  const varietaSelect = supplierElement.find('.varieta-prodotto');
  const currentValue = varietaSelect.val();
  
  varietaSelect.empty();
  varietaSelect.append('<option value="">Seleziona varietà</option>');
  
  if (tipoAgrume && varietyOptions[tipoAgrume]) {
      varietyOptions[tipoAgrume].forEach(function(variety) {
          varietaSelect.append(`<option value="${variety.value}">${variety.text}</option>`);
      });
  }
  
  // Ripristina il valore precedente se ancora valido
  if (currentValue) {
      varietaSelect.val(currentValue);
  }
}

// Calcolo automatico rese in base al tipo di agrume
function calculateAutoYields(agrume) {
  const yields = {
      'LIMONE': { prima: 32, seconda: 5, torchiato: 6 },
      'ARANCIA': { prima: 35, seconda: 12, torchiato: 6 },
      'MANDARINO': { prima: 42, seconda: 10, torchiato: 4 },
      'POMPELMO': { prima: 30, seconda: 15, torchiato: 6 },
      'BERGAMOTTO': { prima: 30, seconda: 8, torchiato: 3 }
  };
  return yields[agrume] || { prima: 45, seconda: 10, torchiato: 4 };
}

// Gestione visibilità sezione succo 2ª in base alla linea
function toggleSecondaSection(supplierElement) {
  const linea = supplierElement.find('.linea-trasformazione').val();
  const secondaSections = supplierElement.find('.seconda-section');
  
  if (linea === 'BOE/1100') {
      secondaSections.removeClass('hidden-field');
  } else {
      secondaSections.addClass('hidden-field');
      // Reset dei valori quando nascosta
      supplierElement.find('.resa-seconda').val('');
      supplierElement.find('.quantita-seconda').val('');
      supplierElement.find('.destinazione-seconda').val('NAT IN TINI');
      supplierElement.find('.pastorizzato-seconda').val('SI');
      supplierElement.find('.tenore-polpa-seconda').val('<1%');
      supplierElement.find('.brix-seconda').val('NAT');
      supplierElement.find('.conservato-seconda').val('SI');
      supplierElement.find('.note-seconda').val('SERB. ESTERNI');
  }
}

// Mostra/nasconde sezione combinazioni
function toggleCombinazioniSection() {
  const hasSuppliers = $('.supplier-row').length > 0;
  
  if (hasSuppliers) {
      $('#combinazioni-section').removeClass('hidden-field');
  } else {
      $('#combinazioni-section').addClass('hidden-field');
  }
}

// Gestione distribuzione quantità per destinazioni - MODIFICATA per mostrare sempre
function updateDistributionSection(supplierElement) {
  const selectedDestinations = supplierElement.find('.destinazione-prima').val() || [];
  const distributionSection = supplierElement.find('.distribution-section');
  const distributionContainer = distributionSection.find('.distribution-container');
  
  if (selectedDestinations.length >= 1) {
      distributionSection.removeClass('hidden-field');
      distributionContainer.empty();
      
      selectedDestinations.forEach(dest => {
          const row = $(`
              <div class="distribution-row">
                  <div class="distribution-dest">${dest}</div>
                  <input type="number" class="form-control distribution-qty" placeholder="kg" min="0" step="0.1" data-dest="${dest}">
              </div>
          `);
          distributionContainer.append(row);
      });
      
      // Aggiungi eventi per calcolo totale
      distributionContainer.find('.distribution-qty').on('input', function() {
          updateDistributionTotal(supplierElement);
      });
      
      // Aggiorna opzioni trasferimento
      updateTransferOptions(supplierElement);
      
      // Calcola immediatamente il rimanente
      updateDistributionTotal(supplierElement);
  } else {
      distributionSection.addClass('hidden-field');
  }
}

// Aggiorna totale distribuzione e gestisce esubero
function updateDistributionTotal(supplierElement) {
  let distributedTotal = 0;
  supplierElement.find('.distribution-qty').each(function() {
      const value = parseFloat($(this).val()) || 0;
      distributedTotal += value;
  });
  
  const quantitaPrima = parseFloat(supplierElement.find('.quantita-prima').val()) || 0;
  const remaining = quantitaPrima - distributedTotal;
  
  // Aggiorna display rimanente
  supplierElement.find('.remaining-value').text(remaining.toFixed(1));
  
  // Gestisci sezione trasferimento esubero
  const transferSection = supplierElement.find('.transfer-section');
  if (remaining > 0) {
      transferSection.removeClass('hidden-field');
      // Imposta automaticamente la quantità di trasferimento al valore rimanente
      supplierElement.find('.transfer-qty').val(remaining.toFixed(1));
  } else {
      transferSection.addClass('hidden-field');
      supplierElement.find('.transfer-qty').val('');
  }
  
  // Aggiorna colore bordo in base al bilanciamento
  if (remaining < 0) {
      supplierElement.find('.distribution-section').css('border-color', '#dc3545');
  } else if (remaining === 0) {
      supplierElement.find('.distribution-section').css('border-color', '#28a745');
  } else {
      supplierElement.find('.distribution-section').css('border-color', '#17a2b8');
  }
}

// Aggiorna opzioni di trasferimento
function updateTransferOptions(supplierElement) {
  const currentSupplierIndex = supplierElement.data('supplier-index');
  const transferSelect = supplierElement.find('.transfer-destination');
  
  transferSelect.empty().append('<option value="">Seleziona fornitore</option>');
  
  $('.supplier-row').each(function() {
      const index = $(this).data('supplier-index');
      if (index !== currentSupplierIndex) {
          const nome = $(this).find('.nome-fornitore').val();
          const altroNome = $(this).find('.altro-fornitore').val();
          const displayName = nome === 'ALTRO' ? altroNome : nome;
          
          if (displayName) {
              transferSelect.append(`<option value="${index}">F${index} - ${displayName}</option>`);
          }
      }
  });
}

// FUNZIONE MODIFICATA: Esegui trasferimento di succo tra fornitori con somma giacenza + trasferimenti
function executeTransfer(sourceSupplierElement) {
  const sourceIndex = sourceSupplierElement.data('supplier-index');
  const targetIndex = sourceSupplierElement.find('.transfer-destination').val();
  const transferAmount = parseFloat(sourceSupplierElement.find('.transfer-qty').val()) || 0;
  
  if (!targetIndex) {
      alert('Seleziona il fornitore di destinazione');
      return;
  }
  
  if (transferAmount <= 0) {
      alert('Inserisci una quantità valida da trasferire');
      return;
  }
  
  const remaining = parseFloat(sourceSupplierElement.find('.remaining-value').text()) || 0;
  if (transferAmount > remaining) {
      alert('La quantità da trasferire non può essere superiore al rimanente');
      return;
  }
  
  // Trova elemento fornitore di destinazione
  const targetSupplierElement = $(`.supplier-row[data-supplier-index="${targetIndex}"]`);
  if (targetSupplierElement.length === 0) {
      alert('Fornitore di destinazione non trovato');
      return;
  }
  
  // Ottieni nomi fornitori per il log
  const sourceName = getSupplierDisplayName(sourceSupplierElement);
  const targetName = getSupplierDisplayName(targetSupplierElement);
  
  // MODIFICA PRINCIPALE: Calcola succo in giacenza dal target + trasferimento
  const quantitaTrasformataTarget = parseFloat(targetSupplierElement.find('.quantita-trasformata').val()) || 0;
  const resaPrimaTarget = parseFloat(targetSupplierElement.find('.resa-prima').val()) || 0;
  
  // Calcola succo base del fornitore target (dalla sua trasformazione)
  const succoBaseTarget = quantitaTrasformataTarget > 0 ? (quantitaTrasformataTarget * resaPrimaTarget / 100) : 0;
  
  // Ottieni trasferimenti già ricevuti dal target
  const currentTransfers = stockPlusTransferData[targetIndex] || [];
  let totalTransfersReceived = 0;
  currentTransfers.forEach(transfer => {
      totalTransfersReceived += transfer.amount;
  });
  
  // Calcola nuovo totale: succo base + trasferimenti precedenti + nuovo trasferimento
  const newTotalTarget = succoBaseTarget + totalTransfersReceived + transferAmount;
  
  // Aggiorna il campo succo 1ª del target
  targetSupplierElement.find('.quantita-prima').val(newTotalTarget.toFixed(1));
  
  // Evidenzia il campo come ricevente trasferimento combinato
  targetSupplierElement.find('.quantita-prima').addClass('stock-plus-transfer');
  
  // Aggiorna dati trasferimenti
  if (!stockPlusTransferData[targetIndex]) {
      stockPlusTransferData[targetIndex] = [];
  }
  
  stockPlusTransferData[targetIndex].push({
      fromSupplier: sourceIndex,
      fromName: sourceName,
      amount: transferAmount,
      timestamp: new Date().toLocaleTimeString('it-IT')
  });
  
  // Aggiorna dettagli trasferimento
  updateTransferDetails(targetSupplierElement, sourceIndex, sourceName, transferAmount, succoBaseTarget, newTotalTarget);
  
  // Reset campi sorgente
  sourceSupplierElement.find('.transfer-destination').val('');
  sourceSupplierElement.find('.transfer-qty').val('');
  
  // Aggiorna distribuzione destinazione
  updateDistributionTotal(targetSupplierElement);
  
  // Ricalcola distribuzione sorgente
  updateDistributionTotal(sourceSupplierElement);
  
  alert(`Trasferimento completato!\n${transferAmount} kg di succo 1ª trasferiti da F${sourceIndex} (${sourceName}) a F${targetIndex} (${targetName})\n\nTotale F${targetIndex}: ${succoBaseTarget.toFixed(1)}kg (giacenza) + ${(totalTransfersReceived + transferAmount).toFixed(1)}kg (trasferimenti) = ${newTotalTarget.toFixed(1)}kg`);
}

// Ottieni nome visualizzato del fornitore
function getSupplierDisplayName(supplierElement) {
  const nome = supplierElement.find('.nome-fornitore').val();
  const altroNome = supplierElement.find('.altro-fornitore').val();
  return nome === 'ALTRO' ? altroNome : nome;
}

// FUNZIONE MODIFICATA: Aggiorna dettagli trasferimento nel fornitore ricevente con calcolo completo
function updateTransferDetails(targetSupplierElement, sourceIndex, sourceName, amount, baseStock, newTotal) {
  const detailsContainer = targetSupplierElement.find('.transfer-details');
  
  // Mostra il container se era nascosto
  detailsContainer.removeClass('hidden-field');
  
  // Calcola totale trasferimenti ricevuti
  const targetIndex = targetSupplierElement.data('supplier-index');
  const allTransfers = stockPlusTransferData[targetIndex] || [];
  let totalTransfers = 0;
  allTransfers.forEach(transfer => {
      totalTransfers += transfer.amount;
  });
  
  // Crea contenuto dettagliato
  let detailsContent = `<strong>Composizione Succo 1ª:</strong><br/>`;
  detailsContent += `• Giacenza: ${baseStock.toFixed(1)} kg<br/>`;
  detailsContent += `• Trasferimenti: ${totalTransfers.toFixed(1)} kg<br/>`;
  detailsContent += `• <strong>Totale: ${newTotal.toFixed(1)} kg</strong><br/>`;
  
  if (allTransfers.length > 0) {
      detailsContent += `<br/><strong>Dettaglio trasferimenti ricevuti:</strong><br/>`;
      allTransfers.forEach(transfer => {
          detailsContent += `• F${transfer.fromSupplier} (${transfer.fromName}): +${transfer.amount}kg<br/>`;
      });
  }
  
  detailsContainer.html(detailsContent);
}

// Resto del codice JavaScript continua identico...
// [Inserire qui tutto il resto del codice JavaScript dalle funzioni precedenti]

// FUNZIONE MODIFICATA: Generazione anteprima stampa con caratteri più grandi e colori richiesti
function generateOrderedColumnPrintPreview(data) {
  const printWindow = window.open('', '_blank');
  
  // Calcola totali per Succo 2ª e Torchiato
  let totalSeconda = 0;
  let totalTorchiato = 0;
  
  data.fornitori.forEach(f => {
      if (f.quantitaTrasformata > 0) {
          if (f.lineaTrasformazione === 'BOE/1100') {
              totalSeconda += (f.quantitaTrasformata * f.rese.seconda / 100);
          }
          totalTorchiato += (f.quantitaTrasformata * f.rese.torchiato / 100);
      }
  });
  
  let printContent = `
      <!DOCTYPE html>
      <html>
      <head>
          <title>Programma Giornaliero - ${data.dataLavorazione}</title>
          <style>
              * {
                  margin: 0;
                  padding: 0;
                  box-sizing: border-box;
              }
              
              body { 
                  font-family: 'Arial', sans-serif;
                  font-size: 14px;
                  line-height: 1.4;
                  color: #000000;
                  margin: 10px;
                  background: #ffffff;
              }
              
              .header {
                  text-align: center;
                  margin-bottom: 20px;
                  background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%);
                  color: #ffffff;
                  padding: 20px;
                  border-radius: 12px;
                  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
              }
              
              .header h1 {
                  font-size: 24px;
                  margin-bottom: 10px;
                  font-weight: bold;
                  text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
              }
              
              .header-info {
                  display: grid;
                  grid-template-columns: repeat(4, 1fr);
                  gap: 15px;
                  margin-top: 15px;
                  font-size: 12px;
                  font-weight: bold;
              }
              
              .totals-grid {
                  display: grid;
                  grid-template-columns: repeat(3, 1fr);
                  gap: 12px;
                  margin-bottom: 20px;
              }
              
              .total-item {
                  text-align: center;
                  padding: 15px;
                  background: linear-gradient(135deg, #f5f5f5 0%, #e0e0e0 100%);
                  border: 3px solid #4a90e2;
                  border-radius: 10px;
                  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
              }
              
              .total-value {
                  font-size: 18px;
                  font-weight: bold;
                  color: #000000;
                  text-shadow: 1px 1px 2px rgba(255,255,255,0.8);
              }
              
              .total-label {
                  font-size: 12px;
                  color: #000000;
                  font-weight: bold;
                  margin-top: 5px;
              }
              
              .suppliers-grid {
                  display: grid;
                  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
                  gap: 15px;
                  margin-bottom: 20px;
              }
              
              .supplier-column {
                  border: 4px solid #4a90e2;
                  border-radius: 15px;
                  page-break-inside: avoid;
                  background: linear-gradient(135deg, #ffffff 0%, #f8f8f8 100%);
                  min-height: 350px;
                  box-shadow: 0 6px 15px rgba(0,0,0,0.15);
                  overflow: hidden;
              }
              
              .supplier-header {
                  background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%);
                  color: #ffffff;
                  padding: 12px;
                  text-align: center;
                  font-weight: bold;
                  font-size: 16px;
                  text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
                  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
              }
              
              .supplier-content {
                  padding: 12px;
                  text-align: center;
              }
              
              .info-section {
                  margin-bottom: 10px;
                  padding: 8px;
                  border-radius: 8px;
                  border: 2px solid;
                  text-align: center;
              }
              
              .fruit-info {
                  background: linear-gradient(135deg, #e8e8e8 0%, #d0d0d0 100%);
                  border-color: #808080;
                  box-shadow: 0 3px 6px rgba(128,128,128,0.2);
              }
              
              .processing-info {
                  background: linear-gradient(135deg, #fff9c4 0%, #ffe082 100%);
                  border-color: #ffa000;
                  box-shadow: 0 3px 6px rgba(255,160,0,0.2);
              }
              
              .timing-info {
                  background: linear-gradient(135deg, #e3f2fd 0%, #90caf9 100%);
                  border-color: #1976d2;
                  box-shadow: 0 3px 6px rgba(25,118,210,0.2);
              }
              
              .products-info {
                  background: linear-gradient(135deg, #ffffff 0%, #f0f0f0 100%);
                  border-color: #757575;
                  box-shadow: 0 3px 6px rgba(117,117,117,0.2);
              }
              
              .distribution-info {
                  background: linear-gradient(135deg, #e8e8e8 0%, #d0d0d0 100%);
                  border-color: #616161;
                  box-shadow: 0 3px 6px rgba(97,97,97,0.2);
              }
              
              .transfer-info {
                  background: linear-gradient(135deg, #fff9c4 0%, #ffe082 100%);
                  border-color: #ff8f00;
                  box-shadow: 0 3px 6px rgba(255,143,0,0.2);
              }
              
              .info-label {
                  font-weight: bold;
                  font-size: 12px;
                  color: #000000;
                  text-transform: uppercase;
                  margin-bottom: 4px;
                  text-shadow: 1px 1px 1px rgba(255,255,255,0.8);
              }
              
              .info-value {
                  font-size: 13px;
                  margin-top: 3px;
                  word-wrap: break-word;
                  color: #000000;
                  font-weight: 600;
                  text-align: center;
              }
              
              .highlighted-value {
                  font-weight: bold;
                  color: #000000;
                  font-size: 15px;
                  text-shadow: 1px 1px 1px rgba(255,255,255,0.5);
              }
              
              .bio-text {
                  color: #d32f2f !important;
                  font-weight: bold;
                  text-shadow: 1px 1px 1px rgba(255,255,255,0.5);
              }
              
              .bio-black-text {
                  color: #000000 !important;
                  font-weight: bold;
                  text-shadow: 1px 1px 1px rgba(255,255,255,0.5);
              }
              
              .combination-column-a {
                  border-color: #ffa000;
                  background: linear-gradient(135deg, #fff9c4 0%, #ffecb3 100%);
                  box-shadow: 0 6px 15px rgba(255,160,0,0.25);
              }
              
              .combination-header-a {
                  background: linear-gradient(135deg, #ffa000 0%, #ff8f00 100%);
                  color: #000000;
                  text-shadow: 1px 1px 2px rgba(255,255,255,0.3);
              }
              
              .combination-column-b {
                  border-color: #4caf50;
                  background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);
                  box-shadow: 0 6px 15px rgba(76,175,80,0.25);
              }
              
              .combination-header-b {
                  background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%);
                  color: #ffffff;
                  text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
              }
              
              .transfer-column {
                  border-color: #ff8f00;
                  background: linear-gradient(135deg, #fff9c4 0%, #ffe082 100%);
                  box-shadow: 0 6px 15px rgba(255,143,0,0.25);
              }
              
              .transfer-header {
                  background: linear-gradient(135deg, #ff8f00 0%, #ffa000 100%);
                  color: #000000;
                  text-shadow: 1px 1px 2px rgba(255,255,255,0.3);
              }
              
              .summary-section {
                  display: grid;
                  grid-template-columns: 1fr 1fr;
                  gap: 15px;
                  margin-top: 20px;
              }
              
              .summary-box {
                  border: 3px solid #4a90e2;
                  padding: 15px;
                  background: linear-gradient(135deg, #f5f5f5 0%, #e0e0e0 100%);
                  border-radius: 10px;
                  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
                  text-align: center;
              }
              
              .summary-title {
                  font-weight: bold;
                  color: #000000;
                  margin-bottom: 8px;
                  font-size: 14px;
                  text-shadow: 1px 1px 1px rgba(255,255,255,0.8);
              }
              
              .summary-item {
                  display: flex;
                  justify-content: space-between;
                  margin-bottom: 4px;
                  font-size: 12px;
                  color: #000000;
                  font-weight: 600;
              }
              
              .footer {
                  text-align: center;
                  margin-top: 20px;
                  font-size: 11px;
                  color: #000000;
                  background: linear-gradient(135deg, #f5f5f5 0%, #e0e0e0 100%);
                  padding: 15px;
                  border-radius: 10px;
                  border: 2px solid #808080;
                  box-shadow: 0 3px 6px rgba(0,0,0,0.1);
              }
              
              .notes-section {
                  background: linear-gradient(135deg, #fff9c4 0%, #ffe082 100%);
                  border: 2px solid #ffa000;
                  padding: 8px;
                  margin-top: 8px;
                  font-size: 11px;
                  border-radius: 6px;
                  box-shadow: 0 3px 6px rgba(255,160,0,0.2);
                  text-align: center;
              }
              
              .distribution-details {
                  font-size: 11px;
                  color: #000000;
                  margin-top: 4px;
                  font-weight: 600;
                  text-align: center;
              }
              
              .transfer-details {
                  font-size: 11px;
                  color: #000000;
                  margin-top: 4px;
                  font-weight: 600;
                  background: rgba(255,193,7,0.3);
                  padding: 6px;
                  border-radius: 6px;
                  text-align: center;
              }
              
              @media print {
                  body { 
                      margin: 8px; 
                      background: white;
                  }
                  .header h1 { font-size: 20px; }
                  .suppliers-grid {
                      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                  }
                  .supplier-column {
                      box-shadow: none;
                      border: 2px solid #333;
                  }
                  .summary-box {
                      box-shadow: none;
                      border: 2px solid #333;
                  }
              }
          </style>
      </head>
      <body>
          <div class="header">
              <h1>PROGRAMMA GIORNALIERO TRASFORMAZIONE FRUTTA</h1>
              <div>Sistema di Gestione Produzione - Simone Gatto</div>
              <div class="header-info">
                  <div><strong>Data:</strong> ${data.dataLavorazione ? new Date(data.dataLavorazione).toLocaleDateString('it-IT') : 'N/D'}</div>
                  <div><strong>Agrume:</strong> ${data.tipoAgrume || 'N/D'}</div>
                  <div><strong>Fornitori:</strong> ${data.fornitori.length}</div>
                  <div><strong>Generato:</strong> ${new Date().toLocaleDateString('it-IT')} ${new Date().toLocaleTimeString('it-IT')}</div>
              </div>
          </div>
          
          <div class="totals-grid">
              <div class="total-item">
                  <div class="total-value">${data.entrataGiornaliera.toLocaleString()}</div>
                  <div class="total-label">Kg Entrata Totale</div>
              </div>
              <div class="total-item">
                  <div class="total-value">${data.trasformataTotale.toLocaleString()}</div>
                  <div class="total-label">Kg Trasformati</div>
              </div>
              <div class="total-item">
                  <div class="total-value">${data.giacenzaTotale.toLocaleString()}</div>
                  <div class="total-label">Kg Giacenza</div>
              </div>
          </div>

          <div class="suppliers-grid">
  `;
  
  // Crea array ordinato di fornitori da F1 a Fn
  const orderedSuppliers = [];
  for (let i = 1; i <= data.fornitori.length; i++) {
      const supplier = data.fornitori.find(f => f.supplierIndex === i);
      if (supplier) {
          orderedSuppliers.push(supplier);
      }
  }
  
  // Genera colonne nell'ordine corretto
  orderedSuppliers.forEach(fornitore => {
      // Determina se il fornitore fa parte di combinazioni
      const isInCombinationA = data.combinationSupplierIndexesA && 
          data.combinationSupplierIndexesA.includes(fornitore.supplierIndex);
      const isInCombinationB = data.combinationSupplierIndexesB && 
          data.combinationSupplierIndexesB.includes(fornitore.supplierIndex);
      
      let combinationType = null;
      if (isInCombinationA) combinationType = 'A';
      if (isInCombinationB) combinationType = 'B';
      
      // Determina se ha ricevuto trasferimenti
      const hasTransfers = fornitore.hasReceivedTransfers;
      
      printContent += generateSupplierColumn(fornitore, fornitore.supplierIndex, combinationType, hasTransfers);
  });
  
  printContent += `
          </div>
  `;
  
  // Sezione riepilogo con caratteri più grandi
  const lastValidSupplierBOE = data.fornitori.filter(f => f.nome && f.lineaTrasformazione === 'BOE/1100').slice(-1)[0];
  const lastValidSupplier = data.fornitori.filter(f => f.nome).slice(-1)[0];
  
  if (totalSeconda > 0 && lastValidSupplierBOE) {
      let destSeconda = lastValidSupplierBOE.destinazioni.seconda || 'N/D';
      if (destSeconda === 'ALTRO' && lastValidSupplierBOE.destinazioni.secondaAltro) {
          destSeconda = lastValidSupplierBOE.destinazioni.secondaAltro;
      }
      
      let destTorchiato = 'N/D';
      if (lastValidSupplier) {
          destTorchiato = lastValidSupplier.destinazioni.torchiato || 'N/D';
          if (destTorchiato === 'ALTRO' && lastValidSupplier.destinazioni.torchiatoAltro) {
              destTorchiato = lastValidSupplier.destinazioni.torchiatoAltro;
          }
      }
      
      printContent += `
              <div class="summary-section">
                  <div class="summary-box">
                      <div class="summary-title">TOTALI SUCCO 2ª</div>
                      <div class="summary-item">
                          <span>Quantità Totale:</span>
                          <span><strong>${totalSeconda.toFixed(1)} kg</strong></span>
                      </div>
                      <div class="summary-item">
                          <span>Destinazione:</span>
                          <span><strong>${destSeconda}</strong></span>
                      </div>
                      <div class="summary-item">
                          <span>Polpa:</span>
                          <span>${lastValidSupplierBOE.caratteristicheProdotti?.seconda?.tenorePolpa || 'N/D'}</span>
                      </div>
                      <div class="summary-item">
                          <span>°BX:</span>
                          <span>${lastValidSupplierBOE.caratteristicheProdotti?.seconda?.brix || 'N/D'}</span>
                      </div>
                      <div class="summary-item">
                          <span>Conservato:</span>
                          <span>${lastValidSupplierBOE.caratteristicheProdotti?.seconda?.conservato || 'N/D'}</span>
                      </div>
                      ${data.sumDetailsSeconda && data.sumDetailsSeconda.length > 1 ? `
                          <div style="margin-top: 6px; font-size: 10px; color: #000000; background: rgba(0,0,0,0.05); padding: 4px; border-radius: 4px;">
                              <strong>Dettaglio:</strong> ${formatSumDetails(data.sumDetailsSeconda, 'seconda')}
                          </div>
                      ` : ''}
                  </div>
                  
                  <div class="summary-box">
                      <div class="summary-title">TOTALI TORCHIATO</div>
                      <div class="summary-item">
                          <span>Quantità Totale:</span>
                          <span><strong>${totalTorchiato.toFixed(1)} kg</strong></span>
                      </div>
                      <div class="summary-item">
                          <span>Destinazione:</span>
                          <span><strong>${destTorchiato}</strong></span>
                      </div>
                      ${lastValidSupplier ? `
                          <div class="summary-item">
                              <span>Polpa:</span>
                              <span>${lastValidSupplier.caratteristicheProdotti?.torchiato?.tenorePolpa || 'N/D'}</span>
                          </div>
                          <div class="summary-item">
                              <span>°BX:</span>
                              <span>${lastValidSupplier.caratteristicheProdotti?.torchiato?.brix || 'N/D'}</span>
                          </div>
                          <div class="summary-item">
                              <span>Conservato:</span>
                              <span>${lastValidSupplier.caratteristicheProdotti?.torchiato?.conservato || 'N/D'}</span>
                          </div>
                      ` : ''}
                      ${data.sumDetailsTorchiato && data.sumDetailsTorchiato.length > 1 ? `
                          <div style="margin-top: 6px; font-size: 10px; color: #000000; background: rgba(0,0,0,0.05); padding: 4px; border-radius: 4px;">
                              <strong>Dettaglio:</strong> ${formatSumDetails(data.sumDetailsTorchiato, 'torchiato')}
                          </div>
                      ` : ''}
                  </div>
              </div>
      `;
  } else {
      let destTorchiato = 'N/D';
      if (lastValidSupplier) {
          destTorchiato = lastValidSupplier.destinazioni.torchiato || 'N/D';
          if (destTorchiato === 'ALTRO' && lastValidSupplier.destinazioni.torchiatoAltro) {
              destTorchiato = lastValidSupplier.destinazioni.torchiatoAltro;
          }
      }
      
      printContent += `
              <div class="summary-section">
                  <div class="summary-box" style="grid-column: 1 / -1;">
                      <div class="summary-title">TOTALI TORCHIATO</div>
                      <div class="summary-item">
                          <span>Quantità Totale:</span>
                          <span><strong>${totalTorchiato.toFixed(1)} kg</strong></span>
                      </div>
                      <div class="summary-item">
                          <span>Destinazione:</span>
                          <span><strong>${destTorchiato}</strong></span>
                      </div>
                      ${lastValidSupplier ? `
                          <div class="summary-item">
                              <span>Polpa:</span>
                              <span>${lastValidSupplier.caratteristicheProdotti?.torchiato?.tenorePolpa || 'N/D'}</span>
                          </div>
                          <div class="summary-item">
                              <span>°BX:</span>
                              <span>${lastValidSupplier.caratteristicheProdotti?.torchiato?.brix || 'N/D'}</span>
                          </div>
                          <div class="summary-item">
                              <span>Conservato:</span>
                              <span>${lastValidSupplier.caratteristicheProdotti?.torchiato?.conservato || 'N/D'}</span>
                          </div>
                      ` : ''}
                      ${data.sumDetailsTorchiato && data.sumDetailsTorchiato.length > 1 ? `
                          <div style="margin-top: 6px; font-size: 10px; color: #000000; background: rgba(0,0,0,0.05); padding: 4px; border-radius: 4px;">
                              <strong>Dettaglio:</strong> ${formatSumDetails(data.sumDetailsTorchiato, 'torchiato')}
                          </div>
                      ` : ''}
                  </div>
              </div>
      `;
  }
  
  printContent += `
              <div class="footer">
                  <p><strong>Documento generato automaticamente - Sistema di Gestione Produzione Simone Gatto</strong></p>
                  <p>Ultima revisione: ${data.ultimaRevisione}</p>
                  <p><strong>Legenda:</strong> (A) = Combinazione A | (B) = Combinazione B | (T) = Trasferimenti | DIST = Distribuzione</p>
              </div>
          </body>
          </html>
  `;
  
  printWindow.document.write(printContent);
  printWindow.document.close();
  printWindow.focus();
}

// FUNZIONE MODIFICATA: Genera una singola colonna fornitore con testo centrato e senza simboli
function generateSupplierColumn(fornitore, supplierIndex, combinationType, hasTransfers) {
  const nomeFornitore = fornitore.nome === 'ALTRO' ? fornitore.altroNome : fornitore.nome;
  const nomeVarieta = fornitore.varieta === 'ALTRO' ? fornitore.altraVarieta : fornitore.varieta;
  
  const isBioSpecific = ['BIO EU', 'BIO DEM', 'BIO NTD', 'BIO DEM/NTD'].includes(fornitore.certificazione);
  const bioStatus = fornitore.caratteristicheProdotti?.prima?.bio || 'N/D';
  const isDeclassatoOrNo = bioStatus === 'DECLASSATO' || bioStatus === 'NO';
  
  const bioClass = isBioSpecific && !isDeclassatoOrNo ? 'bio-text' : 'bio-black-text';
  
  const orarioFineClean = fornitore.orarioFineDisplay ? 
      fornitore.orarioFineDisplay.replace(/<[^>]*>/g, '').replace('del giorno', 'g.') : '';
  
  // Gestione destinazioni
  let destPrima = fornitore.destinazioni.prima ? fornitore.destinazioni.prima : 'N/D';
  if (destPrima.includes('ALTRO') && fornitore.destinazioni.primaAltro) {
      destPrima = destPrima.replace('ALTRO', fornitore.destinazioni.primaAltro);
  }
  destPrima = destPrima.split(', ').map(d => 
      d.replace('CONCENTRATO', 'CONC').replace('NAT IN TINI', 'TINI')
  ).join(', ');
  
  const polpa = fornitore.caratteristicheProdotti?.prima?.tenorePolpa || 'N/D';
  const brix = fornitore.caratteristicheProdotti?.prima?.brix || 'N/D';
  const conservato = fornitore.caratteristicheProdotti?.prima?.conservato || 'N/D';
  const pastorizzato = fornitore.caratteristicheProdotti?.prima?.pastorizzato || 'N/D';
  
  // Note per tutti i prodotti
  const notePrima = fornitore.caratteristicheProdotti?.prima?.note || '';
  const noteSeconda = fornitore.caratteristicheProdotti?.seconda?.note || '';
  const noteTorchiato = fornitore.caratteristicheProdotti?.torchiato?.note || '';
  
  const destBioClass = bioStatus === 'SI' ? 'bio-text' : bioClass;
  
  const certificationBadge = fornitore.certificazione.includes('BIO') ? 
      fornitore.certificazione : fornitore.certificazione;
  
  // Stili per combinazioni e trasferimenti
  let columnClass = 'supplier-column';
  let headerClass = 'supplier-header';
  let headerText = `F${supplierIndex}`;
  
  if (combinationType === 'A') {
      columnClass += ' combination-column-a';
      headerClass = 'supplier-header combination-header-a';
      headerText += ' (A)';
  } else if (combinationType === 'B') {
      columnClass += ' combination-column-b';
      headerClass = 'supplier-header combination-header-b';
      headerText += ' (B)';
  } else if (hasTransfers) {
      columnClass += ' transfer-column';
      headerClass = 'supplier-header transfer-header';
      headerText += ' (T)';
  }
  
  // Gestione distribuzione destinazioni
  let distributionSection = '';
  if (fornitore.distributionData && Object.keys(fornitore.distributionData).length > 0) {
      const distributionItems = Object.entries(fornitore.distributionData)
          .map(([dest, qty]) => `${dest}: ${qty}kg`)
          .join(', ');
      distributionSection = `
          <div class="info-section distribution-info">
              <div class="info-label">Distribuzione Destinazioni</div>
              <div class="distribution-details">${distributionItems}</div>
          </div>
      `;
  }
  
  // Gestione trasferimenti ricevuti con composizione dettagliata
  let transferSection = '';
  if (fornitore.receivedTransfers && fornitore.receivedTransfers.length > 0) {
      // Calcola succo base dalla trasformazione
      const succoBase = fornitore.quantitaTrasformata > 0 ? (fornitore.quantitaTrasformata * fornitore.rese.prima / 100) : 0;
      
      // Calcola totale trasferimenti
      let totalTransfers = 0;
      fornitore.receivedTransfers.forEach(transfer => {
          totalTransfers += transfer.amount;
      });
      
      const transferItems = fornitore.receivedTransfers
          .map(transfer => `F${transfer.fromSupplier}: +${transfer.amount}kg`)
          .join(', ');
          
      transferSection = `
          <div class="info-section transfer-info">
              <div class="info-label">Composizione Succo 1ª</div>
              <div class="transfer-details">
                  <strong>Giacenza:</strong> ${succoBase.toFixed(1)} kg<br/>
                  <strong>Trasferimenti:</strong> ${totalTransfers.toFixed(1)} kg<br/>
                  <strong>Totale:</strong> ${fornitore.quantitaProdotti.prima.toFixed(1)} kg<br/>
                  <em>Da: ${transferItems}</em>
              </div>
          </div>
      `;
  }
  
  // Sezione note complete
  let notesSection = '';
  if (notePrima || noteSeconda || noteTorchiato) {
      let notesContent = '';
      if (notePrima) notesContent += `<div><strong>Succo 1ª:</strong> ${notePrima}</div>`;
      if (noteSeconda) notesContent += `<div><strong>Succo 2ª:</strong> ${noteSeconda}</div>`;
      if (noteTorchiato) notesContent += `<div><strong>Torchiato:</strong> ${noteTorchiato}</div>`;
      
      notesSection = `
          <div class="notes-section">
              <div class="info-label">NOTE</div>
              ${notesContent}
          </div>
      `;
  }
  
  return `
      <div class="${columnClass}">
          <div class="${headerClass}">${headerText}</div>
          <div class="supplier-content">
              <!-- Informazioni Frutta in Ingresso -->
              <div class="info-section fruit-info">
                  <div class="info-label">Fornitore</div>
                  <div class="info-value highlighted-value">${nomeFornitore || 'N/D'}</div>
                  
                  <div class="info-label" style="margin-top: 6px;">Q. in Ingresso</div>
                  <div class="info-value highlighted-value">${fornitore.quantitaEntrata} kg</div>
                  
                  <div class="info-label" style="margin-top: 6px;">Q. da Trasformare</div>
                  <div class="info-value highlighted-value">${fornitore.quantitaTrasformata} kg</div>
                  
                  <div class="info-label" style="margin-top: 6px;">Q. Rimanenza</div>
                  <div class="info-value highlighted-value">${fornitore.giacenza} kg</div>
                  
                  <div class="info-label" style="margin-top: 6px;">Certificazione</div>
                  <div class="info-value ${bioClass}"><strong>${certificationBadge}</strong></div>
                  
                  <div class="info-label" style="margin-top: 6px;">Varietà</div>
                  <div class="info-value ${bioClass}"><strong>${nomeVarieta || 'N/D'}</strong></div>
              </div>
              
              <!-- Linea di Trasformazione -->
              <div class="info-section processing-info">
                  <div class="info-label">Linea di Trasformazione</div>
                  <div class="info-value highlighted-value ${bioClass}"><strong>${fornitore.lineaTrasformazione || 'N/D'}</strong></div>
              </div>
              
              <!-- Informazioni Temporali -->
              <div class="info-section timing-info">
                  <div class="info-label">Orario Inizio</div>
                  <div class="info-value"><strong>${fornitore.orarioInizio || '-'}</strong></div>
                  
                  <div class="info-label" style="margin-top: 6px;">Portata Impianto</div>
                  <div class="info-value"><strong>${fornitore.portataImpianto} kg/h</strong></div>
                  
                  <div class="info-label" style="margin-top: 6px;">Orario Fine</div>
                  <div class="info-value highlighted-value"><strong>${orarioFineClean || '-'}</strong></div>
              </div>
              
              <!-- Informazioni Prodotti -->
              <div class="info-section products-info">
                  <div class="info-label">Succo 1ª</div>
                  <div class="info-value highlighted-value"><strong>${fornitore.quantitaProdotti.prima} kg</strong></div>
                  
                  <div class="info-label" style="margin-top: 6px;">Pastorizzato</div>
                  <div class="info-value"><strong>${pastorizzato}</strong></div>
                  
                  <div class="info-label" style="margin-top: 6px;">Destinazione</div>
                  <div class="info-value ${destBioClass}" style="font-size: 12px;"><strong>${destPrima}</strong></div>
                  
                  <div class="info-label" style="margin-top: 6px;">Polpa</div>
                  <div class="info-value"><strong>${polpa}</strong></div>
                  
                  <div class="info-label" style="margin-top: 6px;">°BX</div>
                  <div class="info-value"><strong>${brix}</strong></div>
                  
                  <div class="info-label" style="margin-top: 6px;">Conservato</div>
                  <div class="info-value"><strong>${conservato}</strong></div>
                  
                  <div class="info-label" style="margin-top: 6px;">Bio</div>
                  <div class="info-value ${destBioClass}"><strong>${bioStatus}</strong></div>
              </div>
              
              ${transferSection}
              ${distributionSection}
              ${notesSection}
          </div>
      </div>
  `;
}

// Eventi principali
$('#tipo-agrume-giornaliero').change(function() {
  const agrume = $(this).val();
  if (agrume) {
      const yields = calculateAutoYields(agrume);
      
      $('.supplier-row').each(function() {
          $(this).find('.resa-prima').val(yields.prima);
          $(this).find('.resa-seconda').val(yields.seconda);
          $(this).find('.resa-torchiato').val(yields.torchiato);
          
          // Aggiorna opzioni varietà per tutti i fornitori esistenti
          updateVarietyOptions($(this), agrume);
          
          calculateYieldQuantities($(this));
          updateDistributionTotal($(this));
      });
      
      updateTotals();
      updateAutoSums();
  }
});

// Pulsanti combinazioni A e B
$('#applica-combinazione-a').click(function() {
  applyCombination('a');
});

$('#reset-combinazione-a').click(function() {
  resetCombination('a');
});

$('#applica-combinazione-b').click(function() {
  applyCombination('b');
});

$('#reset-combinazione-b').click(function() {
  resetCombination('b');
});

// Pulsante aggiungi fornitore
$('#aggiungi-fornitore').click(function() {
  if (!$('#tipo-agrume-giornaliero').val()) {
      alert('Seleziona prima il tipo di agrume');
      return;
  }
  addSupplier();
});

// Pulsante Rese
$('#rese-button').click(function() {
  openYieldsModal();
});

// Chiudi modal rese
$('.close-yields').click(function() {
  closeYieldsModal();
});

// Salva rese
$('#salva-rese').click(function() {
  saveYieldsData();
});

// Reset rese
$('#reset-rese').click(function() {
  resetYieldsData();
});

// Chiudi modal cliccando fuori
$(window).click(function(event) {
  if (event.target.id === 'yields-modal') {
      closeYieldsModal();
  }
});

// Anteprima stampa
$('#anteprima-stampa').click(function() {
  const programData = collectProgramData();
  generateOrderedColumnPrintPreview(programData);
});

// Reset programma
$('#reset-programma').click(function() {
  if (confirm('Attenzione: questa operazione cancellerà tutti i dati inseriti. Continuare?')) {
      location.reload();
  }
});

// Inizializzazione
initCurrentDate();

console.log('Sistema Programma Giornaliero Trasformazione inizializzato con successo - Versione con caratteri grandi e colori migliorati');

// [Inserire qui tutte le altre funzioni mancanti dal codice precedente...]
// Per brevità ho omesso le funzioni identiche, ma vanno incluse tutte quelle dalla versione precedente

});
</script>
</body>
</html>
   
